uart.setup(0,115200,8,0,1,1)dofile("vars.lua")commun={}commun.setup=function()enduser_setup.start(function()print("Connected to wifi as:"..wifi.sta.getip())end,function(a,b)print("enduser_setup: Err #"..a..": "..b)end)tmr.alarm(2,1000,1,function()if wifi.ap.getip()==nil then print("Connecting to AP...")else print("IP Info: \nIP Address: ",wifi.ap.getip())tmr.stop(2)end end)end;commun.put=function(c,d,e)http.put('http://'..vars.server..'/api/v1/devices','Content-Type: text/plain\r\nuid: '..e..'\r\niv: '..d..'\r\n',c,function(f,c)if f<0 then print("HTTP request failed")else print(f,c)end end)end;commun.setup()p_crypto={}p_crypto.p_decrypt=function(g,h)return crypto.decrypt("AES-CBC",vars.key,encoder.fromBase64(g),encoder.fromBase64(h))end;p_crypto.p_encrypt=function(i,IV)encryptedData=crypto.encrypt("AES-CBC",vars.key,i,IV)return encoder.toBase64(encryptedData)end;p_crypto.generate_iv=function()nextnr=10000000;if file.open("counter.num")then nextnr=file.read()file.close()end;if file.open("counter.num","w+")then file.write(nextnr+1)file.close()end;return math.random(10000000,99999999)..nextnr end;ota_updater={}ota_updater.getUpdate=function()http.get('http://'..vars.server..'/api/v1/firmwares','Content-Type: text/plain\r\nuid: '..vars.uid..'\r\nLast-Checksum: '..encoder.toBase64(crypto.fhash("sha256","init.lua"))..'\r\n',function(f,c)if f==200 then fileHmac=crypto.hmac('sha256',c,vars.key)if file.open("hmac.key","w+")then file.write(encoder.toBase64(fileHmac))file.close()end;for j=0,string.len(c),1000 do if file.open("update.tmp","a")then file.write(string.sub(c,j+1,j+1000))file.close()print(string.sub(c,j+1,j+1000))end end;print("update writen to file")elseif f==204 then print("No new Firmware")else print("faild to get update, code: "..f)if c~=nil then print(c)end end end)end;ota_updater.update=function()updateData=''if file.open("update.tmp")then file.close()else ota_updater.getUpdate()return end;ota_updater.verifyAndApplyUpdate()end;ota_updater.readLastChecksum=function()checksum=''if file.open("hmac.key")then checksum=file.read()file.close()end;return checksum end;ota_updater.verifyAndApplyUpdate=function(k,l)http.get('http://'..vars.server..'/api/v1/firmwares?hmac=true','Content-Type: text/plain\r\nuid: '..vars.uid..'\r\n',function(f,c)if f==200 then if ota_updater.readLastChecksum()==c then ota_updater.apply_update("update.tmp")return true else print("hmac invalid")return false end else print("Can't get hmac")end end)end;ota_updater.apply_update=function(m)print(m)file.remove("init.lua.old")file.rename('init.lua','init.lua.old')file.rename(m,'init.lua')file.rename(m,'init.lua')file.rename(m,'init.lua')file.remove("update.tmp")print("init.lua replaced, restart MCU")node.restart()end;loop={}loop.sendData=function()tmr.alarm(0,10000,1,function()IV=p_crypto.generate_iv()encryptedData=p_crypto.p_encrypt("{\"device\": {\"blood_sugars\": [{\"level\": "..math.random(3,32).."}]}}",IV)commun.put(encryptedData,IV,vars.uid)end)end;loop.checkForUpdate=function()tmr.alarm(1,62500,1,function()print("Checking for updated firmware")ota_updater.update()end)end;loop.sendData()loop.checkForUpdate()
