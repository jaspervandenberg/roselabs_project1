uart.setup(0,115200,8,0,1,1)p_crypto={}p_crypto.key=encoder.fromBase64("lKHLOaeUKuUFxkab3xJX8g==")p_crypto.p_decrypt=function(a,b)return crypto.decrypt("AES-CBC",p_crypto.key,encoder.fromBase64(a),encoder.fromBase64(b))end;p_crypto.p_encrypt=function(c,IV)encryptedData=crypto.encrypt("AES-CBC",p_crypto.key,c,IV)return encoder.toBase64(encryptedData)end;p_crypto.generate_iv=function()nextnr=10000000;if file.open("counter.num")then nextnr=file.read()file.close()end;if file.open("counter.num","w+")then file.write(nextnr+1)file.close()end;return math.random(10000000,99999999)..nextnr end;commun={}commun.server="192.168.1.105:3000"commun.setup=function(d,e)enduser_setup.start(function()print("Connected to wifi as:"..wifi.sta.getip())end,function(f,g)print("enduser_setup: Err #"..f..": "..g)end)tmr.alarm(2,1000,1,function()if wifi.ap.getip()==nil then print("Connecting to AP...")else print("IP Info: \nIP Address: ",wifi.ap.getip())tmr.stop(2)end end)end;commun.put=function(h,i,j)http.put('http://'..commun.server..'/api/v1/devices','Content-Type: text/plain\r\nuid: '..j..'\r\niv: '..i..'\r\n',h,function(k,h)if k<0 then print("HTTP request failed")else print(k,h)end end)end;ota_updater={}ota_updater.getUpdate=function(j)http.get('http://'..commun.server..'/api/v1/firmwares','Content-Type: text/plain\r\nuid: '..j..'\r\nLast-Checksum: '..ota_updater.readLastChecksum()..'\r\n',function(k,h)if k==200 then for l=0,string.len(h),1000 do if file.open("update.tmp","a")then file.write(string.sub(h,l+1,l+1000))file.close()print(string.sub(h,l+1,l+1000))end end;print("update writen to file")elseif k==204 then print("No new Firmware")else print("faild to get update, code: "..k)if h~=nil then print(h)end end end)end;ota_updater.update=function(j)updateData=''if file.open("update.tmp")then fileread=file.read()while fileread do if fileread~=nil then updateData=updateData..fileread end;fileread=file.read()end;file.close()else ota_updater.getUpdate(j)return end;print(updateData)updateJson=cjson.decode(updateData)base64_encrypted_checksum=''updatefile=''base64_iv=''for m,n in pairs(updateJson)do if m=='base64_encrypted_checksum'then base64_encrypted_checksum=n elseif m=='base64_file'then updatefile=encoder.fromBase64(n)elseif m=='base64_iv'then base64_iv=n end end;if ota_updater.verify_checksum(updatefile,base64_encrypted_checksum,base64_iv)then file.remove("update.chk")for l=0,string.len(updatefile),1000 do if file.open("update.chk","a")then file.write(string.sub(updatefile,l+1,l+1000))file.close()print(string.sub(updatefile,l+1,l+1000))end end;print("verified firmware writen to file")file.remove("update.tmp")ota_updater.apply_update("update.chk")else print("checksum not valid, updated firmware not writen to flash")end end;ota_updater.writeChecksumToFile=function(checksum)if file.open("version.key","w+")then file.write(checksum)file.close()end end;ota_updater.readLastChecksum=function()checksum=''if file.open("version.key")then checksum=file.read()file.close()end;return checksum end;ota_updater.verify_checksum=function(o,p,b)calculatedUpdateHash=crypto.hash("sha256",o)checksum=p_crypto.p_decrypt(p,b)print(string.sub(encoder.toBase64(checksum),0,43)..'=')print(encoder.toBase64(calculatedUpdateHash))if encoder.toBase64(calculatedUpdateHash)==string.sub(encoder.toBase64(checksum),0,43)..'='then print("checksum valid")ota_updater.writeChecksumToFile(string.sub(encoder.toBase64(checksum),0,43)..'=')return true else print("checksum invalid")return false end end;ota_updater.apply_update=function(q)print(q)file.remove("init.lua.old")file.rename('init.lua','init.lua.old')file.rename(q,'init.lua')file.rename(q,'init.lua')file.rename(q,'init.lua')print("init.lua replaced, restart MCU")node.restart()end;loop={}loop.sendData=function()tmr.alarm(0,10000,1,function()IV=p_crypto.generate_iv()encryptedData=p_crypto.p_encrypt("{\"device\": {\"blood_sugars\": [{\"level\": "..math.random(10,99).."}]}}",IV)commun.put(encryptedData,IV,"ca3u06ICx9iK4AB")end)end;loop.checkForUpdate=function()tmr.alarm(1,62500,1,function()print("Checking for updated firmware")ota_updater.update("ca3u06ICx9iK4AB")end)end;loop.sendData()loop.checkForUpdate()commun.setup("pineapple","notanapple")
